---

- name: Create {{ virtualmin_user }} virtual-server
  shell: "virtualmin create-domain --domain {{ virtualmin_user }}.$(hostname -a) --pass 123456789 --ssl --default-features"
  args:
    creates: /home/{{ virtualmin_user }}

- name: Get dotfiles for {{ virtualmin_user }} user
  git:
    repo: git://github.com/reallifedesign/dotfiles
    dest: /home/{{ virtualmin_user }}/.dotfiles
    update: yes
    accept_hostkey: yes
    update: no
  become: yes
  become_user: "{{ virtualmin_user }}"
  register: dotfiles_exists

- name: Install dotfiles for {{ virtualmin_user }} user
  shell: "rake -f Rakefile.auto install"
  args:
    chdir: /home/{{ virtualmin_user }}/.dotfiles
  become: yes
  become_user: "{{ virtualmin_user }}"
  when: dotfiles_exists.changed

- name: Create ssh key for {{ virtualmin_user }}
  shell: "ssh-keygen -f ~/.ssh/id_rsa -t rsa -N ''"
  become: yes
  become_user: "{{ virtualmin_user }}"
  args:
    creates: /home/{{ virtualmin_user }}/.ssh/id_rsa

- name: Fetch ssh public key for {{ virtualmin_user }}
  tags: test
  fetch:
  args:
    dest: fetched/ssh_keys/{{ virtualmin_user }}/id_rsa.pub
    src: /home/{{ virtualmin_user }}/.ssh/id_rsa.pub
    fail_on_missing: yes
    flat: yes
    validate_checksum: yes


